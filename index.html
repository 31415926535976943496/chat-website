<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>私人訊息聊天室</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: "Segoe UI", sans-serif; }
    body { display: flex; }

    /* ===== 登入 / 註冊畫面 ===== */
    #page-login, #page-register { width:100%; display:none; flex-direction:column; justify-content:center; align-items:center; }
    #page-login.active, #page-register.active { display:flex; }
    .card { width:300px; padding:28px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.08); background:#fff; display:flex; flex-direction:column; gap:12px; }
    .card input, .card button { padding:10px; font-size:1rem; border-radius:6px; border:1px solid #ccc; }
    .card button { background:#3b82f6; color:#fff; border:none; cursor:pointer; transition:.3s; }
    .card button:hover { background:#2563eb; }

    /* ===== 主要區塊 ===== */
    #app { width:100%; display:none; flex-direction:column; }
    #app.active { display:flex; }
    #main { flex:1; display:flex; height:100%; }

    /* ===== 左側側欄 ===== */
    #sidebar { width:280px; display:flex; flex-direction:column; background:#f3f4f6; border-right:1px solid #d1d5db; }
    #sidebar-header { display:flex; align-items:center; padding:14px; gap:8px; }
    #sidebar-header h2 { flex:1; margin:0; font-size:1.2rem; font-weight:700; }
    #btn-menu { width:32px; height:32px; border:none; border-radius:6px; background:#4f6ef7; color:#fff; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    #btn-menu:hover { background:#3a54c7; }

    /* 下拉選單 */
    #dropdown { position:absolute; display:none; flex-direction:column; background:#fff; border:1px solid #ccc; border-radius:6px; box-shadow:0 4px 10px rgba(0,0,0,.15); width:160px; z-index:100; }
    #dropdown div { padding:10px; cursor:pointer; }
    #dropdown div:hover { background:#4f6ef7; color:#fff; }

    /* 搜尋框 */
    #search { margin:0 14px 10px; padding:8px 10px; border:1px solid #cbd5e1; border-radius:6px; width:calc(100% - 28px); }

    /* 清單 */
    #lists { flex:1; overflow-y:auto; padding:0 14px 14px; }
    .item { padding:8px 10px; margin-bottom:6px; background:#fff; border-radius:6px; cursor:pointer; box-shadow:0 1px 4px rgba(0,0,0,.05); }
    .item:hover { background:#e0e7ff; }
    .item.active { background:#627bff; color:#fff; }

    /* 管理員面板 */
    #admin-panel { padding:14px; border-top:1px solid #d1d5db; background:#fee2e2; }
    #admin-panel input { padding:6px; margin-right:6px; }
    #admin-panel button { padding:6px 10px; background:#ef4444; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    #admin-panel button:hover { background:#b91c1c; }

    /* ===== 聊天區 ===== */
    #chat-area { flex:1; display:flex; flex-direction:column; }
    #chat-header { padding:14px; border-bottom:1px solid #d1d5db; font-weight:700; background:#f8fafc; }
    #messages { flex:1; padding:14px; overflow-y:auto; background:#fff; }
    #msg-form { display:flex; padding:12px; border-top:1px solid #d1d5db; background:#f3f4f6; }
    #msg-input { flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:6px; font-size:1rem; }
    #send-btn { padding:10px 16px; margin-left:8px; background:#4f6ef7; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    #send-btn:hover { background:#3a54c7; }
  </style>
</head>
<body>

<!-- ===== 登入 / 註冊頁 ===== -->
<section id="page-login" class="active">
  <div class="card">
    <h2 style="text-align:center">登入</h2>
    <input id="login-user" placeholder="帳號" />
    <input id="login-pass" type="password" placeholder="密碼" />
    <button id="btn-login">登入</button>
    <button id="btn-show-register" style="background:#10b981">註冊</button>
  </div>
</section>
<section id="page-register">
  <div class="card">
    <h2 style="text-align:center">註冊</h2>
    <input id="reg-user" placeholder="帳號" />
    <input id="reg-pass" type="password" placeholder="密碼" />
    <button id="btn-register" style="background:#10b981">送出</button>
    <button id="btn-show-login">返回登入</button>
  </div>
</section>

<!-- ===== 主頁 ===== -->
<section id="app">
  <div id="main">
    <aside id="sidebar">
      <div id="sidebar-header">
        <h2>私人訊息</h2>
        <button id="btn-menu">＋</button>
        <div id="dropdown">
          <div data-action="createRoom">創建聊天室</div>
          <div data-action="addFriend">加好友</div>
        </div>
      </div>
      <input id="search" placeholder="搜尋好友 / 聊天室" />
      <div id="lists"></div>
      <div id="admin-panel" style="display:none;">
        <h3 style="margin:0 0 6px">管理員</h3>
        <input id="admin-add-user" placeholder="帳號" />
        <input id="admin-add-pass" placeholder="密碼" />
        <button id="admin-add-btn">新增</button><br/>
        <input id="admin-del-user" placeholder="刪除帳號" />
        <button id="admin-del-btn">刪除</button>
      </div>
    </aside>

    <div id="chat-area">
      <div id="chat-header">請選擇聊天室或好友</div>
      <div id="messages"></div>
      <form id="msg-form">
        <input id="msg-input" autocomplete="off" placeholder="輸入訊息..." />
        <button id="send-btn">送出</button>
      </form>
    </div>
  </div>
</section>

<script src="/socket.io/socket.io.js"></script>
<script>
/* ========== 全局狀態 ========== */
let socket = null;
let myName = '';
let currentRoom = '';
let friends = [];
let rooms = [];
const roomMap = new Map();

/* ========== DOM ========== */
const loginPage = document.getElementById('page-login');
const registerPage = document.getElementById('page-register');
const appPage = document.getElementById('app');
const listsEl = document.getElementById('lists');
const chatHeader = document.getElementById('chat-header');
const messagesEl = document.getElementById('messages');
const msgForm = document.getElementById('msg-form');
const msgInput = document.getElementById('msg-input');
const searchEl = document.getElementById('search');
const adminPanel = document.getElementById('admin-panel');

/* ========== 切換頁面 ========== */
document.getElementById('btn-show-register').onclick = () => {
  loginPage.classList.remove('active');
  registerPage.classList.add('active');
};

document.getElementById('btn-show-login').onclick = () => {
  registerPage.classList.remove('active');
  loginPage.classList.add('active');
};

/* ========== 註冊 / 登入 ========== */
async function api(url, data) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return res.json();
}

// 登入
