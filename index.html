<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>私人訊息聊天室</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",sans-serif;background:#e8f0fe;height:100vh;display:flex}
    /* ---- 通用 ---- */
    button{cursor:pointer;border:none}
    input,button,select{font-size:1rem}

    /* ---- 登入 ---- */
    #page-login,#page-app{width:100%;display:none;align-items:center;justify-content:center}
    #page-login.active,#page-app.active{display:flex;flex-direction:column}
    #login-card{background:#fff;padding:32px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.1);width:300px;display:flex;flex-direction:column;gap:12px}
    #login-card input{padding:10px;border:1px solid #ccc;border-radius:6px}
    #login-card button{padding:10px;border-radius:6px;background:#3b82f6;color:#fff;transition:.2s}
    #login-card button:hover{background:#2563eb}
    small{margin-top:6px;font-size:.85rem;color:#555}

    /* ---- 主要佈局 ---- */
    #page-app{flex-direction:column;padding:10px 0}
    #main{flex:1;display:flex;width:100%;max-width:1200px;margin:auto;box-shadow:0 6px 18px rgba(0,0,0,.08);border-radius:12px;overflow:hidden;background:#fff}

    /* ---- 左側側邊欄 ---- */
    #sidebar{width:260px;display:flex;flex-direction:column;border-right:1px solid #d1d5db;background:#f9fafe}
    #sidebar-header{padding:12px;border-bottom:1px solid #d1d5db;display:flex;flex-direction:column;gap:8px}
    #search-friend{padding:8px;border:1px solid #cbd5e1;border-radius:6px}
    #sidebar-title{display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:1.05rem}
    #btn-create-room{background:#3b82f6;color:#fff;width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:.2s}
    #btn-create-room:hover{background:#2563eb}
    #friend-room-list{flex:1;overflow-y:auto}
    .item{padding:10px 14px;border-bottom:1px solid #e5e7eb;cursor:pointer}
    .item:hover{background:#e0e7ff}
    .item.active{background:#bfdbfe;font-weight:700}

    /* ---- 右側聊天 ---- */
    #chat-area{flex:1;display:flex;flex-direction:column}
    #chat-header{padding:14px;border-bottom:1px solid #d1d5db;font-weight:700;background:#f4f5f7}
    #messages{flex:1;padding:16px;overflow-y:auto}
    #msg-form{display:flex;padding:12px;border-top:1px solid #d1d5db;background:#f9fafb}
    #msg-input{flex:1;padding:10px;border:1px solid #cbd5e1;border-radius:6px}
    #send-btn{margin-left:10px;padding:10px 16px;border-radius:6px;background:#2563eb;color:#fff;transition:.2s}
    #send-btn:hover{background:#1e40af}

    /* ---- 管理員 ---- */
    #admin-panel{width:100%;max-width:1200px;background:#fee2e2;border-top:4px solid #ef4444;border-radius:8px;margin:8px auto 0;padding:14px;display:none}
    #admin-panel input{padding:6px;border:1px solid #ef4444;border-radius:4px;margin-right:6px}
    #admin-panel button{padding:6px 10px;background:#ef4444;color:#fff;border-radius:4px;margin-right:6px}
  </style>
</head>
<body>
  <!-- 登入頁 -->
  <section id="page-login" class="active">
    <div id="login-card">
      <h2 style="text-align:center">登入 / 註冊</h2>
      <input id="username" placeholder="帳號" required>
      <input id="password" type="password" placeholder="密碼" required>
      <button id="login-btn">登入</button>
      <button id="register-btn" style="background:#10b981">註冊</button>
      <small>管理員帳號：<b>admin / 123456</b></small>
    </div>
  </section>

  <!-- 主頁 -->
  <section id="page-app">
    <h2 id="welcome" style="text-align:center;margin-bottom:8px"></h2>
    <div id="main">
      <!-- 側邊欄 -->
      <aside id="sidebar">
        <div id="sidebar-header">
          <input id="search-friend" placeholder="搜尋好友...">
          <div id="sidebar-title">
            <span>私人訊息</span>
            <button id="btn-create-room" title="新增聊天室">＋</button>
          </div>
        </div>
        <div id="friend-room-list">
          <!-- 動態插入好友 & 房間 -->
        </div>
      </aside>

      <!-- 聊天區 -->
      <div id="chat-area">
        <div id="chat-header">請選擇聊天室</div>
        <div id="messages"></div>
        <form id="msg-form">
          <input id="msg-input" autocomplete="off" placeholder="輸入訊息...">
          <button id="send-btn">送出</button>
        </form>
      </div>
    </div>

    <!-- 管理員面板 -->
    <div id="admin-panel">
      <h3 style="margin-bottom:6px">管理員面板</h3>
      <input id="admin-add-user" placeholder="帳號">
      <input id="admin-add-pass" placeholder="密碼">
      <button id="admin-add-btn">新增帳號</button>
      <input id="admin-del-user" placeholder="欲刪除帳號">
      <button id="admin-del-btn">刪除帳號</button>
    </div>
  </section>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    /* ========== DOM ========== */
    const pgLogin = document.getElementById('page-login');
    const pgApp   = document.getElementById('page-app');
    const welcome = document.getElementById('welcome');

    const usernameEl = document.getElementById('username');
    const passwordEl = document.getElementById('password');
    const loginBtn   = document.getElementById('login-btn');
    const registerBtn= document.getElementById('register-btn');

    const sidebarList= document.getElementById('friend-room-list');
    const searchInput= document.getElementById('search-friend');
    const createRoomBtn=document.getElementById('btn-create-room');

    const chatHeader = document.getElementById('chat-header');
    const messagesEl = document.getElementById('messages');
    const msgForm    = document.getElementById('msg-form');
    const msgInput   = document.getElementById('msg-input');

    const adminPanel = document.getElementById('admin-panel');

    /* ========== 狀態 ========== */
    let myName = '';
    let token  = '';
    let socket = null;
    let currentRoom = '';
    let allFriends = [];
    let allRooms   = [];

    /* ====== API ====== */
    async function api(url,data){
      const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
      return res.json();
    }

    /* ====== 登入、註冊 ====== */
    loginBtn.onclick = async ()=>{
      const r=await api('/api/login',{username:usernameEl.value.trim(),password:passwordEl.value});
      if(r.ok){ token=r.token; myName=token; afterLogin(); } else alert(r.msg);
    };
    registerBtn.onclick = async ()=>{
      const r=await api('/api/register',{username:usernameEl.value.trim(),password:passwordEl.value});
      alert(r.ok? '註冊成功，請登入':r.msg);
    };

    /* ====== 登入後 ====== */
    function afterLogin(){
      pgLogin.classList.remove('active');
      pgApp.classList.add('active');
      welcome.textContent=`歡迎，${myName}`;
      if(myName==='admin') adminPanel.style.display='block';

      socket = io({auth:{token}});

      socket.on('friends', list=>{ allFriends=list; renderSidebar(); });
      socket.on('rooms',   list=>{ allRooms=list;   renderSidebar(); });
      socket.on('system',  msg=>appendMsg(`[系統] ${msg}`));
      socket.on('message', data=>{ if(data.room===currentRoom) appendMsg(`${data.from}: ${data.text}`); });

      /* 搜尋過濾 */
      searchInput.addEventListener('input', renderSidebar);

      /* 建立聊天室按鈕 */
      createRoomBtn.onclick = ()=>{
        const roomName = prompt('輸入新的聊天室名稱：');
        if(roomName) socket.emit('createRoom', roomName.trim());
      };

      /* 發送訊息 */
      msgForm.addEventListener('submit', e=>{
        e.preventDefault();
        const txt=msgInput.value.trim();
        if(txt && currentRoom){ socket.emit('chat',{roomId:currentRoom,text:txt}); msgInput.value=''; }
      });

      /* 管理員功能 */
      document.getElementById('admin-add-btn').onclick=()=>{
        socket.emit('adminAdd',{username:document.getElementById('admin-add-user').value.trim(),password:document.getElementById('admin-add-pass').value});
      };
      document.getElementById('admin-del-btn').onclick=()=>{
        socket.emit('adminDel',document.getElementById('admin-del-user').value.trim());
      };
    }

    /* ====== UI 渲染 ====== */
    function renderSidebar(){
      const kw = searchInput.value.trim().toLowerCase();
      sidebarList.innerHTML='';

      // 好友
      const friendHeader=document.createElement('div');friendHeader.style.cssText='padding:8px 14px;font-weight:700;color:#6366f1;border-bottom:1px solid #e5e7eb';friendHeader.textContent='好友';
      sidebarList.appendChild(friendHeader);
      allFriends.filter(f=>f.toLowerCase().includes(kw)).forEach(f=>{
        const div=document.createElement('div');div.className='item';div.textContent=f;
        div.onclick=()=>createOrOpenFriendRoom(f);
        sidebarList.appendChild(div);
      });

      // 聊天室
      const roomHeader=document.createElement('div');roomHeader.style.cssText='padding:8px 14px;font-weight:700;color:#6366f1;border-bottom:1px solid #e5e7eb;margin-top:4px';roomHeader.textContent='聊天室';
      sidebarList.appendChild(roomHeader);
      allRooms.filter(r=>r.name.toLowerCase().includes(kw)).forEach(r=>{
        const div=document.createElement('div');div.className='item';if(r.id===currentRoom) div.classList.add('active');
        div.textContent=r.name;div.onclick=()=>joinRoom(r.id,r.name);
        sidebarList.appendChild(div);
      });
    }

    /* ====== 功能方法 ====== */
    function createOrOpenFriendRoom(friend){
      const roomName=`和 ${friend} 聊天`;
      const exist=allRooms.find(r=>r.name===roomName);
      if(exist){ joinRoom(exist.id,exist.name); return; }
      socket.emit('createRoom',roomName);
    }

    function joinRoom(id,name){
      currentRoom=id; chatHeader.textContent=name; messagesEl.innerHTML='';
      socket.emit('joinRoom',id);
      renderSidebar();
    }

    function appendMsg(text){
      const div=document.createElement('div');div.textContent=text;messagesEl.appendChild(div);
      messagesEl.scrollTop=messagesEl.scrollHeight;
    }
  </script>
</body>
</html>
