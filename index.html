<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>聊天室</title>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
    #sidebar { width: 240px; background: #f5f5f5; display: flex; flex-direction: column; padding: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
    #sidebar h2 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
    #friends, #rooms { margin-top: 10px; flex-grow: 1; overflow-y: auto; }
    #friends div, #rooms div { padding: 6px; margin-bottom: 4px; background: #fff; border-radius: 4px; cursor: pointer; }
    #chat { flex: 1; display: flex; flex-direction: column; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; }
    #inputBox { display: flex; }
    #input { flex: 1; padding: 10px; }
    #send { padding: 10px; }
    #login, #register { display: flex; flex-direction: column; max-width: 300px; margin: auto; }
    .hidden { display: none; }
    #search { width: 100%; padding: 5px; margin-bottom: 10px; }
  </style>
</head>
<body>

<div id="login">
  <h2>登入</h2>
  <input id="loginName" placeholder="帳號">
  <input id="loginPass" placeholder="密碼" type="password">
  <button onclick="login()">登入</button>
  <button onclick="showRegister()">註冊</button>
</div>

<div id="register" class="hidden">
  <h2>註冊</h2>
  <input id="registerName" placeholder="帳號">
  <input id="registerPass" placeholder="密碼" type="password">
  <button onclick="register()">送出</button>
  <button onclick="showLogin()">返回</button>
</div>

<div id="main" class="hidden">
  <div id="sidebar">
    <h2>
      私人訊息
      <button onclick="showOptions()">＋</button>
    </h2>
    <input id="search" placeholder="搜尋好友" oninput="filterList()">
    <div id="friends"></div>
    <div id="rooms"></div>
    <div id="adminPanel" style="margin-top:auto">
      <h4>管理員操作</h4>
      <input id="adminUser" placeholder="帳號">
      <input id="adminPass" placeholder="密碼" type="password">
      <button onclick="adminAdd()">新增</button>
      <button onclick="adminDel()">刪除</button>
    </div>
  </div>
  <div id="chat">
    <div id="messages"></div>
    <div id="inputBox">
      <input id="input" placeholder="輸入訊息...">
      <button id="send" onclick="sendMessage()">送出</button>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
let socket;
let currentRoom = '';
let username = '';

function showLogin() {
  document.getElementById('login').classList.remove('hidden');
  document.getElementById('register').classList.add('hidden');
}
function showRegister() {
  document.getElementById('register').classList.remove('hidden');
  document.getElementById('login').classList.add('hidden');
}

function login() {
  const name = document.getElementById('loginName').value;
  const pass = document.getElementById('loginPass').value;
  fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: name, password: pass })
  }).then(res => res.json()).then(data => {
    if (data.ok) {
      username = name;
      document.getElementById('login').classList.add('hidden');
      document.getElementById('main').classList.remove('hidden');
      socket = io({ auth: { token: username } });
      setupSocket();
    } else {
      alert(data.msg);
    }
  });
}

function register() {
  const name = document.getElementById('registerName').value;
  const pass = document.getElementById('registerPass').value;
  fetch('/api/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: name, password: pass })
  }).then(res => res.json()).then(data => {
    if (data.ok) {
      alert('註冊成功，請登入');
      showLogin();
    } else {
      alert(data.msg);
    }
  });
}

function setupSocket() {
  socket.on('friends', list => {
    const container = document.getElementById('friends');
    container.innerHTML = '';
    list.forEach(name => {
      const div = document.createElement('div');
      div.textContent = name;
      div.onclick = () => {
        const roomName = `和 ${name} 聊天`;
        socket.emit('rooms', [], () => {});
        joinRoomByName(roomName);
      };
      container.appendChild(div);
    });
  });

  socket.on('rooms', list => {
    window.roomMap = {};
    const container = document.getElementById('rooms');
    container.innerHTML = '';
    list.forEach(r => {
      roomMap[r.name] = r.id;
      const div = document.createElement('div');
      div.textContent = r.name;
      div.onclick = () => joinRoom(r.id);
      container.appendChild(div);
    });
  });

  socket.on('message', ({ from, text }) => {
    const div = document.createElement('div');
    div.textContent = `${from}: ${text}`;
    document.getElementById('messages').appendChild(div);
  });

  socket.on('system', msg => {
    const div = document.createElement('div');
    div.textContent = `[系統] ${msg}`;
    div.style.color = 'gray';
    document.getElementById('messages').appendChild(div);
  });
}

function joinRoom(id) {
  currentRoom = id;
  document.getElementById('messages').innerHTML = '';
  socket.emit('joinRoom', id);
}

function joinRoomByName(name) {
  const id = window.roomMap?.[name];
  if (id) joinRoom(id);
}

function sendMessage() {
  const input = document.getElementById('input');
  if (input.value && currentRoom) {
    socket.emit('chat', { roomId: currentRoom, text: input.value });
    input.value = '';
  }
}

function showOptions() {
  const type = prompt('輸入 addFriend 或 createRoom');
  if (type === 'addFriend') {
    const name = prompt('好友帳號');
    socket.emit('addFriend', name);
  } else if (type === 'createRoom') {
    const name = prompt('聊天室名稱');
    socket.emit('createRoom', name);
  }
}

function adminAdd() {
  const name = document.getElementById('adminUser').value;
  const pass = document.getElementById('adminPass').value;
  socket.emit('adminAdd', { username: name, password: pass });
}
function adminDel() {
  const name = document.getElementById('adminUser').value;
  socket.emit('adminDel', name);
}
function filterList() {
  const keyword = document.getElementById('search').value.toLowerCase();
  document.querySelectorAll('#friends div').forEach(div => {
    div.style.display = div.textContent.toLowerCase().includes(keyword) ? '' : 'none';
  });
}
</script>
</body>
</html>
